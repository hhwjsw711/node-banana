---
phase: 06-video-and-polish
plan: 03
type: execute
---

<objective>
Add dynamic model parameters fetched from provider schemas.

Purpose: Allow users to customize model-specific parameters (like seed, steps, guidance_scale) based on what each model supports. Addresses ISS-001.
Output: Generate nodes show dynamic parameter inputs based on selected model's schema.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md

# Prior plans in this phase:
@.planning/phases/06-video-and-polish/06-01-SUMMARY.md
@.planning/phases/06-video-and-polish/06-02-SUMMARY.md

# Key source files:
@src/app/api/models/route.ts
@src/components/nodes/GenerateImageNode.tsx
@src/components/nodes/GenerateVideoNode.tsx
@src/types/index.ts

**Issue being addressed:** ISS-001 - Generate node should adapt to model requirements
**Established patterns:**
- Models have openapi_schema field from provider APIs (already fetched but not exposed)
- parameters?: Record<string, unknown> passed to generation API
**Constraining decisions:**
- Use provider schema, don't hardcode parameters
- Common parameters to expose: seed, num_inference_steps, guidance_scale, negative_prompt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema endpoint and model schema fetching</name>
  <files>
    src/app/api/models/[modelId]/route.ts,
    src/lib/providers/types.ts,
    src/app/api/models/route.ts
  </files>
  <action>
Create endpoint to fetch individual model schema:
1. Create src/app/api/models/[modelId]/route.ts:
   - GET /api/models/:modelId (modelId is URL-encoded, e.g., "fal-ai%2Fflux%2Fdev")
   - Parse provider from query param: ?provider=fal
   - For Replicate:
     - Fetch model from https://api.replicate.com/v1/models/{owner}/{name}
     - Extract latest_version.openapi_schema.components.schemas.Input
     - Return simplified parameter schema
   - For fal.ai:
     - Fetch from https://fal.run/{modelId}/api (returns OpenAPI spec)
     - Extract requestBody schema properties
     - Return simplified parameter schema
2. In providers/types.ts, add ModelParameter interface:
   ```typescript
   interface ModelParameter {
     name: string;
     type: "string" | "number" | "integer" | "boolean" | "array";
     description?: string;
     default?: unknown;
     minimum?: number;
     maximum?: number;
     enum?: unknown[];
     required?: boolean;
   }
   ```
3. Schema simplification:
   - Filter to user-relevant params: exclude internal params like "webhook", "sync_mode"
   - Include: prompt (if not already handled), seed, num_inference_steps, guidance_scale, negative_prompt, width, height, num_outputs
   - Return as ModelParameter[] array
4. Add caching for schema (same pattern as model list, 10 min TTL)
  </action>
  <verify>
curl "http://localhost:3000/api/models/fal-ai%2Fflux%2Fdev?provider=fal" returns parameter schema
  </verify>
  <done>API endpoint returns model parameter schema for both Replicate and fal.ai models</done>
</task>

<task type="auto">
  <name>Task 2: Add parameter UI component</name>
  <files>
    src/components/nodes/ModelParameters.tsx,
    src/components/nodes/GenerateImageNode.tsx,
    src/components/nodes/GenerateVideoNode.tsx
  </files>
  <action>
Create reusable parameter input component:
1. Create src/components/nodes/ModelParameters.tsx:
   - Props: modelId, provider, parameters, onParametersChange
   - Fetch schema from /api/models/{modelId}?provider={provider} when modelId changes
   - Render appropriate input for each parameter type:
     - string: text input (or select if enum)
     - number/integer: number input with min/max
     - boolean: checkbox
     - array: skip for now (complex)
   - Show parameter name, description on hover
   - Compact styling to fit in node (10px font, tight spacing)
   - Collapsible section: "Parameters" header, collapsed by default
   - Only show if model is selected (not Gemini)
2. Integrate into GenerateImageNode:
   - Import ModelParameters component
   - Add below model selector when external provider selected
   - Store parameters in nodeData.parameters
   - Pass to API call
3. Integrate into GenerateVideoNode:
   - Same integration as GenerateImageNode
4. Update node data types:
   - Add parameters?: Record<string, unknown> to NanoBananaNodeData
   - Already exists in GenerateVideoNodeData if copied from 06-01
  </action>
  <verify>npm run build passes, parameter inputs appear when selecting external model</verify>
  <done>Parameter inputs render based on model schema, values stored in node data</done>
</task>

<task type="auto">
  <name>Task 3: Pass parameters through generation pipeline</name>
  <files>
    src/store/workflowStore.ts,
    src/app/api/generate/route.ts
  </files>
  <action>
Ensure parameters flow through to providers:
1. In workflowStore.ts executeWorkflow:
   - For nanoBanana node: include nodeData.parameters in API request body
   - For generateVideo node: same inclusion
2. In API route.ts:
   - Parameters already spread into predictionInput/requestBody via ...input.parameters
   - Verify this is working correctly
   - Add logging: log which parameters are being passed
3. Validate parameter types before sending:
   - Coerce strings to numbers where schema expects number
   - Filter out empty/undefined values
   - Don't send default values (let model use its defaults)
4. Handle parameter errors:
   - If provider rejects parameter, surface error clearly
   - Show which parameter was invalid in error message
  </action>
  <verify>
Test generation with custom parameters (e.g., seed=12345), verify parameter appears in API logs
  </verify>
  <done>Custom parameters successfully passed to providers and affect generation output</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] Schema endpoint returns parameters for Replicate and fal.ai models
- [ ] Parameter inputs appear in Generate nodes for external models
- [ ] Parameter values persist in node data
- [ ] Parameters are sent to providers during generation
- [ ] Custom seed produces reproducible results (if model supports it)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- ISS-001 addressed: nodes adapt inputs to model requirements
- Users can customize model-specific parameters
</success_criteria>

<output>
After completion, create `.planning/phases/06-video-and-polish/06-03-SUMMARY.md`
</output>
